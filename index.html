<html>
  <head>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    <a-scene>      
      <!-- Ассеты -->
      <a-assets>
        <audio id="click-sound" src="sounds/blip/blick_click.wav"></audio>
        <audio id="blip2" src="sounds/blip/blip_enter.wav"></audio>
      </a-assets>

      <!-- Камера с raycaster для управления мышью -->
      <a-camera 
        position="0 1 0" 
        wasd-controls="enabled: false" 
        look-controls="enabled: true" 
        raycaster="objects: .clickable; far: 10; lineColor: white; lineOpacity: 0.5" 
        cursor="rayOrigin: mouse"
        sound="src: #click-sound; on: click">
      </a-camera>

      <!-- Контроллеры Pico 4 -->
      <a-entity 
        id="left-controller" 
        laser-controls="hand: left" 
        position="0 1 0" 
        raycaster="objects: .clickable; far: 10; lineColor: white; lineOpacity: 0.5"
        sound="src: #click-sound; on: click">
      </a-entity>
      <a-entity 
        id="right-controller" 
        laser-controls="hand: right" 
        position="0 1 0" 
        raycaster="objects: .clickable; far: 10; lineColor: white; lineOpacity: 0.5"
        sound="src: #click-sound; on: click">
      </a-entity>

      <!-- Динамичный фон с environment -->
      <a-entity id="background" environment="preset: starry;"></a-entity>

      <!-- Основная сцена -->
      <a-entity id="main-scene">
        <a-sky color="#ECECEC"></a-sky>
        <a-entity position="0 1 -2">
          <a-plane 
            id="button-next" 
            class="clickable" 
            width="1" height="0.4" 
            color="#008CBA"
            hoverable>
            <a-text value="Next" align="center" color="white" position="0 0 0.01"></a-text>
          </a-plane>
        </a-entity>
      </a-entity>

      <!-- Транзитная сцена -->
      <a-entity id="transition-scene" visible="false">
        <a-entity position="0 1 -4">
          <a-text id="msg-one" value="HI" align="center" color="white" scale="2 2 2" opacity="1"></a-text>
          <a-text id="msg-two" value="Second msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
          <a-text id="msg-three" value="Three msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
          <a-text id="msg-four" value="Four msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
          <a-text id="msg-five" value="Five msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
          <a-text id="msg-six" value="Six msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
        </a-entity>

        <a-entity id="portals">
          <a-entity id="portal1">
            <a-circle position="-2 1 -0.5" rotation="0 90 0" radius="0.450" color="#00FFFF" opacity="0" visible="true"></a-circle>
          </a-entity>
          <a-entity id="portal2">
            <a-circle position="-1 1 -2" rotation="0 0 0" radius="0.450" color="#FF00FF" opacity="0" visible="true"></a-circle>
          </a-entity>
          <a-entity id="portal3">
            <a-circle position="1 1 -2" rotation="0 0 0" radius="0.450" color="#FF00FF" opacity="0" visible="true"></a-circle>
          </a-entity>
          <a-entity id="portal4">
            <a-circle position="0 1 1" rotation="0 -180 0" radius="0.450" color="#FF00FF" opacity="0" visible="true"></a-circle>
          </a-entity>
          <a-entity id="portal5">
            <a-circle position="1.5 1 -0.5" rotation="0 -90 0" radius="0.450" color="#FF00FF" opacity="0" visible="true"></a-circle>
          </a-entity>
          <a-light id="portal-light" type="spot" color="#FFFFFF" intensity="0" position="0 -1 -2" angle="60" target="#msg-six"></a-light>
        </a-entity>

        <a-entity position="2 1 0" rotation="0 -90 0">
          <a-plane id="button-back" width="1" height="0.4" color="#008CBA" hoverable>
            <a-text value="Back" align="center" color="white" position="0 0 0.01"></a-text>
          </a-plane>
        </a-entity>
      </a-entity>

      <!-- РПО сцена -->
      <a-entity id="rpo-scene" visible="false">
        <a-sky color="#1A1A2E"></a-sky>

        <!-- Шестеренки -->
        <a-entity position="-2 1 -3" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 5000">
          <a-torus radius="0.5" radius-tubular="0.05" arc="360" color="#FFD700"></a-torus>
        </a-entity>
        <a-entity position="2 2 -4" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 7000">
          <a-torus radius="0.7" radius-tubular="0.05" arc="360" color="#FFD700"></a-torus>
        </a-entity>
        <a-entity position="0 3 -2" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 6000">
          <a-torus radius="0.3" radius-tubular="0.05" arc="360" color="#FFD700"></a-torus>
        </a-entity>

        <!-- Падающий цифровой код -->
        <a-entity position="0 5 -3" animation="property: position; to: 0 -5 -3; loop: true; dur: 4000">
          <a-text value="101010 001 111 0101" color="#00FF00" align="center" scale="1 1 1"></a-text>
        </a-entity>
        <a-entity position="2 5 -4" animation="property: position; to: 2 -5 -4; loop: true; dur: 4500">
          <a-text value="110011 010 101 1100" color="#00FF00" align="center" scale="1 1 1"></a-text>
        </a-entity>
        <a-entity position="-2 5 -2" animation="property: position; to: -2 -5 -2; loop: true; dur: 3800">
          <a-text value="010101 111 000 1010" color="#00FF00" align="center" scale="1 1 1"></a-text>
        </a-entity>

        <!-- Сопроводитель -->
        <a-entity id="guide" position="0 1.5 -3">
          <a-text id="guide-text" value="Добро пожаловать в мир РПО!\nЯ — твой Сопроводитель.\nТы попал в пространство разработки программного обеспечения,\nгде код оживает, а механизмы технологий работают в гармонии."
                  color="#FFFFFF" align="center" width="4" scale="1 1 1" opacity="0"
                  animation="property: opacity; from: 0; to: 1; dur: 2000; delay: 1000"></a-text>
        </a-entity>

        <!-- Опции выбора -->
        <a-entity id="rpo-options" position="0 1 -3" visible="false" animation="property: visible; to: true; dur: 0; delay: 4000">
          <a-entity position="-1.5 0.5 0">
            <a-plane id="option1" class="clickable" width="1" height="0.4" color="#008CBA" hoverable>
              <a-text value="Что такое РПО?" align="center" color="white" position="0 0 0.01"></a-text>
            </a-plane>
          </a-entity>
          <a-entity position="0 0.5 0">
            <a-plane id="option2" class="clickable" width="1" height="0.4" color="#008CBA" hoverable>
              <a-text value="Что я буду делать?" align="center" color="white" position="0 0 0.01"></a-text>
            </a-plane>
          </a-entity>
          <a-entity position="1.5 0.5 0">
            <a-plane id="option3" class="clickable" width="1" height="0.4" color="#008CBA" hoverable>
              <a-text value="Попробовать задание!" align="center" color="white" position="0 0 0.01"></a-text>
            </a-plane>
          </a-entity>
        </a-entity>

        <!-- Задание -->
        <a-entity id="challenge" visible="false">
          <a-text id="challenge-text" value="Найди правильный код, чтобы включить свет!" position="0 2 -3" color="#FFFFFF" align="center" scale="1 1 1"></a-text>
          <a-entity position="-1.5 1 -3">
            <a-plane id="code1" class="clickable" width="0.8" height="0.3" color="#FF4444">
              <a-text value="0101" align="center" color="white" position="0 0 0.01"></a-text>
            </a-plane>
          </a-entity>
          <a-entity position="0 1 -3">
            <a-plane id="code2" class="clickable" width="0.8" height="0.3" color="#FF4444">
              <a-text value="1100" align="center" color="white" position="0 0 0.01"></a-text>
            </a-plane>
          </a-entity>
          <a-entity position="1.5 1 -3">
            <a-plane id="code3" class="clickable" width="0.8" height="0.3" color="#FF4444">
              <a-text value="1010" align="center" color="white" position="0 0 0.01"></a-text>
            </a-plane>
          </a-entity>
          <a-light id="challenge-light" type="ambient" intensity="0" color="#FFFFFF"></a-light>
        </a-entity>
      </a-entity>

      <!-- Дизайн сцена -->
      <a-entity id="dizayn-scene" visible="false">
        <a-sky color="#ECECEC"></a-sky>
        <a-entity position="0 1 -4">
          <a-text id="dizayn-msg-one" value="DIZAYN" align="center" color="white" scale="2 2 2" opacity="1"></a-text>
        </a-entity>
      </a-entity>

      <!-- Туризм сцена -->
      <a-entity id="turizm-scene" visible="false">
        <a-sky color="#ECECEC"></a-sky>
        <a-entity position="0 1 -4">
          <a-text id="turizm-msg-one" value="TURIZM" align="center" color="white" scale="2 2 2" opacity="1"></a-text>
        </a-entity>
      </a-entity>
      
      <!-- Сервис сцена -->
      <a-entity id="service-scene" visible="false">
        <a-sky color="#ECECEC"></a-sky>
        <a-entity position="0 1 -4">
          <a-text id="service-msg-one" value="SERVICE" align="center" color="white" scale="2 2 2" opacity="1"></a-text>
        </a-entity>
      </a-entity>

      <!-- Реклама сцена -->
      <a-entity id="reklama-scene" visible="false">
        <a-sky color="#ECECEC"></a-sky>
        <a-entity position="0 1 -4">
          <a-text id="reklama-msg-one" value="REKLAMA" align="center" color="white" scale="2 2 2" opacity="1"></a-text>
        </a-entity>
      </a-entity>

    </a-scene>

    <script>
      // Компонент для эффекта наведения
      AFRAME.registerComponent('hoverable', {
        init: function () {
          var el = this.el;
          el.addEventListener('mouseenter', function () {
            el.setAttribute('color', '#005F7F');
          });
          el.addEventListener('mouseleave', function () {
            el.setAttribute('color', '#008CBA');
          });
        }
      });

      // Логика переключения на транзитную сцену
      document.querySelector('#button-next').addEventListener('click', async function () {
        console.log('click');
        const mainScene = document.querySelector('#main-scene');
        const transitionScene = document.querySelector('#transition-scene');
        const buttonNext = document.querySelector('#button-next');
        const buttonBack = document.querySelector('#button-back');
        const background = document.querySelector('#background');

        mainScene.setAttribute('visible', 'false');
        transitionScene.setAttribute('visible', 'true');
        buttonNext.classList.remove('clickable');
        buttonBack.classList.add('clickable');
        background.setAttribute('environment', 'preset: forest');

        const messages = [
          { id: '#msg-one', delay: 1000 },
          { id: '#msg-two', delay: 1000 },
          { id: '#msg-three', delay: 1000 },
          { id: '#msg-four', delay: 1000 },
          { id: '#msg-five', delay: 1000 },
          { id: '#msg-six', delay: 0 }
        ];

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
        const animationDuration = 1000;
        const pauseBeforeFadeIn = 1000;

        const animateOpacity = (element, from, to, duration) => {
          return new Promise(resolve => {
            element.setAttribute('animation', {
              property: 'opacity',
              from: from,
              to: to,
              dur: duration,
              easing: 'easeInOutQuad'
            });
            element.addEventListener('animationcomplete', function handler() {
              if (to === 0) {
                element.classList.remove('clickable');
              } else if (to > 0) {
                element.classList.add('clickable');
              }
              element.removeEventListener('animationcomplete', handler);
              resolve();
            }, { once: true });
          });
        };

        for (let i = 0; i < messages.length - 1; i++) {
          const current = document.querySelector(messages[i].id);
          const next = document.querySelector(messages[i + 1].id);

          await sleep(messages[i].delay - animationDuration);
          await animateOpacity(current, 1, 0, animationDuration);
          current.parentNode.removeChild(current);
          await sleep(pauseBeforeFadeIn);
          await animateOpacity(next, 0, 1, animationDuration);

          if (next.id === 'msg-six') {
            const portalsContainer = document.querySelector('#portals');
            const portals = portalsContainer.querySelectorAll('a-circle');
            const portalLight = document.querySelector('#portal-light');
            
            await sleep(500);
            for (const portal of portals) {
              await animateOpacity(portal, 0, 0.8, animationDuration);
              await sleep(300);
            }
            portalLight.setAttribute('intensity', '1');
          }
        }
      });

      // Логика переключения обратно на основную сцену
      document.querySelector('#button-back').addEventListener('click', function () {
        console.log('click');
        const mainScene = document.querySelector('#main-scene');
        const transitionScene = document.querySelector('#transition-scene');
        const buttonNext = document.querySelector('#button-next');
        const buttonBack = document.querySelector('#button-back');
        const background = document.querySelector('#background');
        
        transitionScene.setAttribute('visible', 'false');
        mainScene.setAttribute('visible', 'true');
        buttonBack.classList.remove('clickable');
        buttonNext.classList.add('clickable');
        background.setAttribute('environment', 'preset: starry');
      });

      // Функция для обработки перехода по клику на портал
      function handlePortalClick(portalId, targetSceneId, environmentPreset) {
        document.querySelector(`#${portalId} a-circle`).addEventListener('click', function () {
          console.log(`${portalId} clicked`);
          const transitionScene = document.querySelector('#transition-scene');
          const targetScene = document.querySelector(`#${targetSceneId}`);
          const portals = document.querySelector('#portals').querySelectorAll('a-circle');
          const background = document.querySelector('#background');

          portals.forEach(portal => portal.classList.remove('clickable'));
          transitionScene.setAttribute('visible', 'false');
          targetScene.setAttribute('visible', 'true');
          background.setAttribute('environment', `preset: ${environmentPreset}`);
        });
      }

      // Применяем функцию для каждого портала
      handlePortalClick('portal1', 'rpo-scene', 'none');
      handlePortalClick('portal2', 'dizayn-scene', 'goldmine');
      handlePortalClick('portal3', 'turizm-scene', 'egypt');
      handlePortalClick('portal4', 'service-scene', 'japan');
      handlePortalClick('portal5', 'reklama-scene', 'volcano');

      // Логика для сцены РПО
      document.querySelector('#option1').addEventListener('click', () => showRpoInfo());
      document.querySelector('#option2').addEventListener('click', () => showRpoTasks());
      document.querySelector('#option3').addEventListener('click', () => startRpoChallenge());

      function showRpoInfo() {
        const guideText = document.querySelector('#guide-text');
        const options = document.querySelector('#rpo-options');
        options.setAttribute('visible', 'false');
        guideText.setAttribute('value', 'РПО — это разработка программного обеспечения\nдля дизайна и технологий.\nЗдесь ты будешь создавать программы,\nкоторые помогают дизайнерам воплощать идеи в жизнь.');
      }

      function showRpoTasks() {
        const guideText = document.querySelector('#guide-text');
        const options = document.querySelector('#rpo-options');
        options.setAttribute('visible', 'false');
        guideText.setAttribute('value', 'Ты будешь писать код для приложений,\nсоздавать алгоритмы для обработки данных\nи разрабатывать интерфейсы для дизайнеров.');
      }

      function startRpoChallenge() {
        const guideText = document.querySelector('#guide-text');
        const options = document.querySelector('#rpo-options');
        const challenge = document.querySelector('#challenge');
        options.setAttribute('visible', 'false');
        guideText.setAttribute('visible', 'false');
        challenge.setAttribute('visible', 'true');

        document.querySelector('#code1').addEventListener('click', () => tryCode(false));
        document.querySelector('#code2').addEventListener('click', () => tryCode(false));
        document.querySelector('#code3').addEventListener('click', () => tryCode(true));
      }

      function tryCode(isCorrect) {
        const challengeText = document.querySelector('#challenge-text');
        const light = document.querySelector('#challenge-light');
        if (isCorrect) {
          challengeText.setAttribute('value', 'Отлично! Свет включен!');
          light.setAttribute('intensity', '1');
          setTimeout(() => {
            challengeText.setAttribute('value', 'Поздравляю! Ты сделал первый шаг в РПО.\nХочешь узнать больше или вернуться?');
            const moreBtn = document.createElement('a-plane');
            moreBtn.setAttribute('id', 'more-btn');
            moreBtn.setAttribute('class', 'clickable');
            moreBtn.setAttribute('width', '1');
            moreBtn.setAttribute('height', '0.4');
            moreBtn.setAttribute('color', '#008CBA');
            moreBtn.setAttribute('position', '-1 0.5 -3');
            moreBtn.innerHTML = '<a-text value="Узнать больше" align="center" color="white" position="0 0 0.01"></a-text>';
            challenge.appendChild(moreBtn);

            const backBtn = document.createElement('a-plane');
            backBtn.setAttribute('id', 'back-btn');
            backBtn.setAttribute('class', 'clickable');
            backBtn.setAttribute('width', '1');
            backBtn.setAttribute('height', '0.4');
            backBtn.setAttribute('color', '#008CBA');
            backBtn.setAttribute('position', '1 0.5 -3');
            backBtn.innerHTML = '<a-text value="Назад" align="center" color="white" position="0 0 0.01"></a-text>';
            challenge.appendChild(backBtn);

            moreBtn.addEventListener('click', () => showRpoDetails());
            backBtn.addEventListener('click', () => returnToTransition());
          }, 1000);
        } else {
          challengeText.setAttribute('value', 'Попробуй еще!');
        }
      }

      function showRpoDetails() {
        const challenge = document.querySelector('#challenge');
        const guideText = document.querySelector('#guide-text');
        guideText.setAttribute('visible', 'true');
        challenge.setAttribute('visible', 'false');
        guideText.setAttribute('value', 'В РПО ты можешь разрабатывать\nинструменты для дизайнеров,\nнапример, программы для 3D-моделирования\nили обработки изображений.');
      }

      function returnToTransition() {
        document.querySelector('#rpo-scene').setAttribute('visible', 'false');
        document.querySelector('#transition-scene').setAttribute('visible', 'true');
        document.querySelector('#background').setAttribute('environment', 'preset: forest');
      }
    </script>
  </body>
</html>