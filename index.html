<html>
  <head>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    <a-scene>      
      <!-- Ассеты -->
      <a-assets>
        <audio id="click-sound" src="sounds/blip/blick_click.wav"></audio>
        <audio id="blip2" src="sounds/blip/blip_enter.wav"></audio>
      </a-assets>

      <!-- Камера с raycaster для управления мышью -->
      <a-camera 
        position="0 1 0" 
        wasd-controls="enabled: false" 
        look-controls="enabled: true" 
        raycaster="objects: .clickable; far: 10; lineColor: white; lineOpacity: 0.5" 
        cursor="rayOrigin: mouse"
        sound="src: #click-sound; on: click">
      </a-camera>

      <!-- Контроллеры Pico 4 -->
      <a-entity 
        id="left-controller" 
        laser-controls="hand: left" 
        position="0 1 0" 
        raycaster="objects: .clickable; far: 10; lineColor: white; lineOpacity: 0.5"
        sound="src: #click-sound; on: click">
      </a-entity>

      <a-entity 
        id="right-controller" 
        laser-controls="hand: right" 
        position="0 1 0" 
        raycaster="objects: .clickable; far: 10; lineColor: white; lineOpacity: 0.5"
        sound="src: #click-sound; on: click">
      </a-entity>

      <!-- Основная сцена -->
      <a-entity id="main-scene">
        <a-sky color="#ECECEC"></a-sky>
        <a-entity environment="preset: starry;"></a-entity>

        <!-- Кнопка "Next" -->
        <a-entity position="0 1 -2">
          <a-plane 
            id="button-next" 
            class="clickable" 
            width="1" height="0.4" 
            color="#008CBA"
            hoverable>
          </a-plane>
          <a-text value="Next" align="center" color="white" position="0 0 0.01"></a-text>
        </a-entity>
      </a-entity>

      <!-- Вторая сцена -->
      <a-entity id="scene2" visible="false">
        <a-entity environment="preset: forest;"></a-entity>
        
        <a-entity position="0 1 -4">
          <a-text id="msg-one" value="HI" align="center" color="white" scale="2 2 2" opacity="1"></a-text>
          <a-text id="msg-two" value="Second msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
          <a-text id="msg-three" value="Three msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
          <a-text id="msg-four" value="Four msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
          <a-text id="msg-five" value="Five msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
          <a-text id="msg-six" value="Six msg" align="center" color="white" scale="2 2 2" opacity="0" visible="true"></a-text>
          <!-- Портал -->
          <a-ring 
            id="portal" 
            radius-inner="0.5" 
            radius-outer="1" 
            color="#00FFFF" 
            opacity="0" 
            position="0 -1 0" 
            rotation="90 0 0" 
            visible="true" 
            animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear">
          </a-ring>
        </a-entity>

        <!-- Кнопка "Back" -->
        <a-entity position="2 1 0" rotation="0 -90 0">
          <a-plane 
            id="button-back" 
            width="1" height="0.4" 
            color="#008CBA"
            hoverable>
          </a-plane>
          <a-text value="Back" align="center" color="white" position="0 0 0.01"></a-text>
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      // Компонент для эффекта наведения
      AFRAME.registerComponent('hoverable', {
        init: function () {
          var el = this.el;
          el.addEventListener('mouseenter', function () {
            el.setAttribute('color', '#005F7F');
          });
          el.addEventListener('mouseleave', function () {
            el.setAttribute('color', '#008CBA');
          });
        }
      });

      // Логика переключения на вторую сцену
      document.querySelector('#button-next').addEventListener('click', async function () {
        console.log('click');
        const mainScene = document.querySelector('#main-scene');
        const scene2 = document.querySelector('#scene2');
        const buttonNext = document.querySelector('#button-next');
        const buttonBack = document.querySelector('#button-back');

        mainScene.setAttribute('visible', 'false');
        scene2.setAttribute('visible', 'true');
        buttonNext.classList.remove('clickable');
        buttonBack.classList.add('clickable');

        const messages = [
          { id: '#msg-one', delay: 3000 },
          { id: '#msg-two', delay: 4000 },
          { id: '#msg-three', delay: 2500 },
          { id: '#msg-four', delay: 1000 },
          { id: '#msg-five', delay: 1000 },
          { id: '#msg-six', delay: 0 }
        ];

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
        const animationDuration = 1000; // Длительность анимации текста
        const pauseBeforeFadeIn = 1000; // Пауза перед появлением текста
        const portalAnimationDuration = 2000; // Длительность анимации портала

        // Функция для запуска анимации
        const animateOpacity = (element, from, to, duration) => {
          return new Promise(resolve => {
            element.setAttribute('animation', {
              property: 'opacity',
              from: from,
              to: to,
              dur: duration,
              easing: 'easeInOutQuad'
            });
            element.addEventListener('animationcomplete', resolve, { once: true });
          });
        };

        // Функция для анимации портала (подъем и прозрачность)
        const animatePortal = (element) => {
          return new Promise(resolve => {
            element.setAttribute('animation__position', {
              property: 'position',
              from: '0 -1 0',
              to: '0 0 0',
              dur: portalAnimationDuration,
              easing: 'easeInOutQuad'
            });
            element.setAttribute('animation__opacity', {
              property: 'opacity',
              from: 0,
              to: 1,
              dur: portalAnimationDuration,
              easing: 'easeInOutQuad'
            });
            element.addEventListener('animationcomplete', resolve, { once: true });
          });
        };

        // Инициализация: первое сообщение уже видно (opacity="1")
        for (let i = 0; i < messages.length - 1; i++) {
          const current = document.querySelector(messages[i].id);
          const next = document.querySelector(messages[i + 1].id);

          // Ждем перед началом исчезновения
          await sleep(messages[i].delay - animationDuration);

          // Плавное исчезновение текущего
          await animateOpacity(current, 1, 0, animationDuration);

          // Удаляем текущий элемент
          current.parentNode.removeChild(current);

          // Пауза перед появлением следующего
          await sleep(pauseBeforeFadeIn);

          // Плавное появление следующего
          await animateOpacity(next, 0, 1, animationDuration);

          // Если это последнее сообщение (msg-six), показываем портал
          if (i === messages.length - 2) {
            const portal = document.querySelector('#portal');
            await sleep(500); // Небольшая пауза перед появлением портала
            await animatePortal(portal);
          }
        }
      });

      // Логика переключения обратно на основную сцену
      document.querySelector('#button-back').addEventListener('click', function () {
        console.log('click');
        var mainScene = document.querySelector('#main-scene');
        var scene2 = document.querySelector('#scene2');
        var buttonNext = document.querySelector('#button-next');
        var buttonBack = document.querySelector('#button-back');
        
        scene2.setAttribute('visible', 'false');
        mainScene.setAttribute('visible', 'true');
        buttonBack.classList.remove('clickable');
        buttonNext.classList.add('clickable');
      });
    </script>
  </body>
</html>